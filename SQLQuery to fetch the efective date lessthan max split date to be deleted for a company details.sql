--PYTHO,SQL,AZURE DATA FACTORY AND POWER BI ETL DEVELOPER --> GNANESHWAR SRAVANE
USE Estimates

IF OBJECT_ID('tempdb..#ed') IS NOT NULL DROP TABLE #ed
SELECT DISTINCT ed.versionid,ed.feedFileId,ed.companyid,edn.dataItemId,peo=dbo.formatPeriodId_fn(ed.estimateperiodid),ed.tradingItemId,
dataitemname=dbo.DataItemName_fn(edn.dataitemid),dm.flagEAG,dm.dataCollectionTypeID ,ed.effectiveDate
INTO #ed FROM Estimates.dbo.EstimateDetail_tbl ed (NOLOCK)
INNER JOIN Estimates.[dbo].[EstFull_vw] edn (NOLOCK) ON ed.estimateDetailId = edn.estimateDetailId
INNER JOIN Estimates.dbo.DATAITEMMASTER_VW dm (NOLOCK) ON edn.dataItemId=dm.dataItemId
WHERE ed.companyId IN (278914626,1882484122,1875413304,556182014,1881294811,1881806442,1881294712,1870961535,1882220106,1800639554,39435139,1817557513,1883215011,1792633815,1877854736,1883449805,685602834,1883449181,1868852254,1861793979,1878885724,1875283714,1881294569,1780429721,1879111037,1879111070,669729615,1858819143,1858818963,403573192,1792633815,1877854736,1875508987,1881386997,1883739521,606328043,1880546828,1877755296,37444562,1879111094,1879732450,648536874,1800784651,1881064779,1672834977,116517229,1880533509,1672834977,1880899303,1884001327,1883896318,1884001284,37444562,707496192,1877275081,1791146318,1883740304,1801063397,1787937709,29383636,1774736891,1858900962,573262766,1878884905,1857464355,1858016936,1830563544,1828397500,1884116076,1764704247,1838766950,254340805,49685523,606328043,1759738243,1791146306,1882359207,1687061582,1881381389,597793062,1874819440,34256990,1761411945,1830956739,256429605,226949064,1798327902,652178236,1859254185,1680294239,1784474575,1881064779,1789542110,1857464355,1849817514,344165767,1884072175,1884072882,1883892507,26581481,1875216921,1875217108,1881367603,1878286382,1878286381,1884287306,379564459,1884281874,1884286748,1883713939,1869767565,1884231817,705657695,1884306536,7222855,1870802557,1870802558,254340805,29513698,1680101648,414791590,1884394256,1867485712,1872447176,1872896227,290800955,1802014112,1881382974,1881382641,1881382680,1871120849,271153436,1683577772,1855487465,1869500728,663749159,640183565,1848234603,1847802922,1878729984,1884491835,321403700,1846764292,1881765571,1884196973,1877142012,1877142011,1877142010,1884434149,711855838,1798914548,1875791230,1880533509,1872254257,711855838,1776043242,1884588853,1874124656,9708825,261332687,1848619808,1881641406,1877832515,1872341313,1872341314,1872341311,1877846497,1877846352,544592758,1880899303,321823804,561944832,1849006304,1877293884,580518990,226949064,418824143,1674078924,561944832,1884735807,1884736001,1875168341,1884721268,550038523,704384080,1884608559,1884649558,660059091,1878202499,261332688,1875837547,1872341312,1872341315,691024012,1872255149,1877684727,79065416,222783771,559295312,1801111932,1869769718,1823875648,687069284,1758424320,1780798021,645764123,1884847541,1780798021,694773014,1877970871,416182164,1875508837,1877285104,1881723870,1880510824,694773014,1877970871,1818495453,1885043377,1885081624,693353919,1884965913,1879053889,1856536837,1876140177,1884807456,1884608145,1884941458,1881641506,52816573,1860906727,1848380709,1872999081,691024012,1872836094,384489200,281793173,1854232729,1847296564,61015467,1873570454,1884790432,1884789972,1884792520,271609426,1883241302,1880058692,1880542762,1859809578,1877230204,1870796592,1873498264,261332687,278914626,1881141344,41352294,1881341682,1877905978,1784929725,51547227,1881241126,1884231817,1046845,1885173907,1862731499,1885088351,1858650259,1874123010,702594919,1884463713,1856264150,673443054,52560697,407722300,1882340279,1794135459,1880552614,105846464,1882269249,1858650259,1874529743,1872999081,1847296564,1885090315,311185560,1872836094,226949064,384489200,281793173,278914626,51547227,1871705430,698206929,1871287445,711440557,1869443374,1877141978,1877141979,1885124969,1791810065,1884972640,1851408453,278914626,1870961441,1872602602,1874688879,1845913762,599501433,1881341682,1765442207,1672516830,1784929725,51547227,1881241126,634800431,227964707,1882059802,1883837702,535699389,687475577,1884631155,1860221291,257217648,1864862133,204730176,370472303,585498440,1883747796,47229250,59555336,50205974,668692561,1874649330,712194807,1884863337,1881911040,1882432427,271153436,1761529706,1874106353,49677918,694533424,1803493850,1884557324,1884626703,410797742,1879178044,1883856922,1883861254,1883861195,1850980545,251740971,311230194,1858671235,32628571,611445449,1822187699,1878377177,1878377176,1878248481,589848858,1851408453,1793970384,1803826807,1830056930,1875697042,1872602602,1874688879,226949064,1843922547,1882431466,1879441726,1874577251,1805545765,1780580077,1764704247,1863621069,554537323,171095807,331760790,1769844621,1885425421,575639748,529741328,1868802769,364687910,1885574083,557440765,1848612234,1873501141,208721181,1863187806,83749670,1818126119,1874106353,1875957212,1877518897,1878469489,580518990,585498440,556182014,1864598142,32628571,1874597932,1800269653,1885614659,1881936474,50958496,251740971,311230194,1883695862,1860836214,32628571,702594919,1876949700,611445449,1827650993,1822187699,1841273282,589848858,250429582,1879669569,1875697042,673443054,1784633578,575938698,571925122,568596330,112993819,407722300,1764704247,1885823561,282077986,1885831478,638696553,1885746499,1882117761,1885758986,1885687960,1885545585,1880298231,145576747,1883421740,1871155175,50209005,1862475750,1874594572,1874597775,1871154815,1856896935,1877863354,83749670,1857121615,1869442809,1879333264,432426492,247622072,645960986,1864598142,1883696268,317333205,1885988114,1885987689,1686517198,1857289887,714519851,1880106386,1885500646,1885991378,1881953447,1874524794,1885991894,1874846544,1874846543,672643147,1801114870,245181897,1885094081,245181897,97352053,1855490675,1859256079,1868852253,117536598,1879977123,1879977122,1880950030,706425038,1884356277,1883840158,1886211617,1883840154,1884400606,1883840155,1883840157,6561833,700152226,244463871,556917101,1884522567,552422826,1886304093,1884159128,1758749382,1858808555,1783087690,1883840156,1883840153,1857121615,1884306536,1823945392,432426492,247622072,645960986,1863420218,1859254185,1828746377,1858808555,685189991,1759738243,413495550,1859254185,1828746377,685189991,410799017,1886661716,36811483,1864667778,1885730390,1881329898,23248480,693238786,1834991315,36811483,1865385206,1865083545,1878289125,1852368288,97352053,1883837702,1862658074,1864667778,250540025,206737885,410717724,1855490675)
--AND ed.tradingItemId IN (20217083,20243624)
AND dm.flavorTypeId IN (2) AND dm.dataCollectionTypeID IN (54,56,62)

SELECT edd.CompanyId,edd.TradingItemId,COUNT(DISTINCT(ISNULL(edd.versionid,edd.feedFileId))) AS CountOfVersions,
COUNT(dataItemId) AS CountOfPer_share_Dataitem FROM #ed edd
INNER JOIN EstimateSplitInfo_tbl es (NOLOCK) ON edd.companyId = es.companyId AND edd.tradingItemId = es.tradingItemId
WHERE edd.effectiveDate < es.exDate
GROUP BY edd.CompanyId,edd.TradingItemId

--efective date <= max split date to be deleted for a company 
--select * from EstimateSplitInfo_tbl where companyId=29574


SELECT edd.* FROM #ed edd
INNER JOIN EstimateSplitInfo_tbl es (NOLOCK) ON edd.companyId = es.companyId AND edd.tradingItemId = es.tradingItemId
WHERE edd.effectiveDate < es.exDate
ORDER BY edd.effectiveDate

