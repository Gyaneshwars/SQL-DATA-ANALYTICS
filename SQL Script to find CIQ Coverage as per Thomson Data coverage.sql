
--PYTHON,SQL,AZURE DATA FACTORY AND POWER BI ETL DATA ANALYTICS DEVELOPER --> GNANESHWAR SRAVANE

USE Estimates

IF OBJECT_ID('TEMPDB..#CCComb') IS NOT NULL DROP TABLE #CCComb  
CREATE TABLE #CCComb (researchContributorId INT,companyId INT); 
INSERT INTO #CCComb (researchContributorId ,companyId) VALUES
(3,393269),(3,744808),(3,875895),(3,876923),(3,878546),(3,884397),(3,1719233),(3,2200577),(3,4484222),(3,4509051),(3,6478902),(3,6521087),
(3,11016235),(3,20385555),(3,34536531),(3,38747234),(3,128792870),(3,261393013),(3,278887416),(3,1684487582),(3,1844243432),(3,19049),(3,21401),
(3,26642),(3,28274),(3,28756),(3,30655),(3,31468),(3,31500),(3,32307),(3,32583),(3,96161),(3,97999),(3,106437),(3,112732),(3,126269),(3,168569),
(3,169838),(3,170352),(3,175265),(3,191328),(3,248501),(3,255397),(3,257151),(3,259378),(3,262125),(3,268472),(3,269764),(3,269924),(3,270586),
(3,274265),(3,274561),(3,274715),(3,280322),(3,289030),(3,289062),(3,291385),(3,291896),(3,294338),(3,294483),(3,294639),(3,295688),(3,296527),
(3,303104),(3,307982),(3,310903),(3,318049),(3,318929),(3,323261),(3,323746),(3,324289),(3,328020),(3,329376),(3,329501),(3,330706),(3,331908),
(3,332358),(3,336458),(3,343729),(3,353253),(3,363003),(3,384586),(3,387127),(3,387513),(3,390225),(3,391070),(3,397809),(3,398625),(3,404476),
(3,411950),(3,426137),(3,427949),(3,435998),(3,683713),(3,836768),(3,874225),(3,881155),(3,934467),(3,955855),(3,972190),(3,986834),(3,3004786),
(3,3131592),(3,3449701),(3,6569181),(3,13103664),(3,23957317),(3,25460099),(3,25848899),(3,30822601),(3,34322384),(3,35921712),(3,36385735),
(3,37326955),(3,44459532),(3,51174327),(3,59505020),(3,61023831),(3,74859451),(3,84159238),(3,109373551),(3,118218449),(3,133833909),
(3,170205476),(3,212766522),(3,228809907),(3,231691952),(3,241908542),(3,253706543),(3,253891410),(3,254957567),(3,260334235),(3,262264756),
(3,263559030),(3,266797777),(3,272761870),(3,279346385),(3,283154866),(3,305614922),(3,315986912),(3,316229534),(3,324565060),(3,337454005),
(3,344562930),(3,345057935),(3,403055588),(3,413547123),(3,424080297),(3,540573682),(3,545985501),(3,552805228),(3,567714077),(3,571787485)

--SELECT * FROM #CCComb

IF OBJECT_ID('TEMPDB..#CoverageVIDs') IS NOT NULL DROP TABLE #CoverageVIDs 
SELECT DISTINCT rd.researchcontributorid,rd.contributorShortName,CT.relatedCompanyId,MAX(ED.effectiveDate) AS MaxFilingDate
INTO #CoverageVIDs
FROM WorkflowArchive_Estimates.[dbo].CommonTracker_vw CT
LEFT JOIN   workflow_Estimates.[dbo].CollectionEntityToProcessToDataPoint_tbl cdp (NOLOCK) ON cdp.collectionEntityToProcessId = CT.collectionEntityToProcessId AND cdp.datapointid  = 1887
LEFT JOIN   Estimates.[dbo].Estimates_IndustrySubTypeToCollectionProcess_tbl  est (NOLOCK) ON est.industrysubtypeid = cdp.value 
LEFT JOIN   workflow_Estimates.[dbo].collectionprocess_tbl cp (NOLOCK) ON cp.collectionProcessId = ISNULL(est.collectionProcessId,CT.collectionProcessId) 
INNER JOIN  Estimates.[dbo].EstimateDetail_tbl ED (NOLOCK) ON ISNULL(ED.versionId,ED.feedFileId) = CT.collectionEntityId AND ED.companyId = CT.relatedCompanyId
INNER JOIN  Estimates.[dbo].[EstFull_vw] EDND (NOLOCK) ON EDND.estimateDetailId = ED.estimateDetailId
LEFT JOIN   ComparisonData.[dbo].ResearchContributor_tbl rd (NOLOCK) ON rd.researchcontributorid = ED.researchcontributorid
INNER JOIN  Workflow_Estimates.[dbo].[CollectionStageStatus_tbl] css (NOLOCK) ON css.collectionStageStatusId = CT.collectionstageStatusId
--INNER JOIN   Estimates.dbo.Event_tbl e (NOLOCK) ON ISNULL(e.versionId,e.feedFileId) = ISNULL(ED.versionId,ED.feedFileId) AND e.companyId = ED.companyId
--LEFT JOIN  Estimates.dbo.EventType_tbl et (NOLOCK) ON  et.eventtypeid=e.eventtypeid
WHERE       CT.collectionEntityTypeId IN (9,51) ---AND CT.collectionStageId IN (2)
AND         CT.collectionstageStatusId IN (4)
AND			CT.startDate IS NOT NULL
AND			CT.endDate IS NOT NULL
AND			rd.contributorShortName IS NOT NULL
AND         EDND.dataItemId IN (21625,21626,21634,21635,21638,21642,21649,21650,21661,114208) ---OR (et.eventTypeId IN (1,10)))
AND         rd.researchcontributorid IN (3)
AND         CT.relatedcompanyid IN (393269,744808,875895,876923,878546,884397,1719233,2200577,4484222,4509051,6478902,6521087,11016235,20385555,34536531,38747234,128792870,261393013,278887416,1684487582,1844243432,19049,21401,26642,28274,28756,30655,31468,31500,32307,32583,96161,97999,106437,112732,126269,168569,169838,170352,175265,191328,248501,255397,257151,259378,262125,268472,269764,269924,270586,274265,274561,274715,280322,289030,289062,291385,291896,294338,294483,294639,295688,296527,303104,307982,310903,318049,318929,323261,323746,324289,328020,329376,329501,330706,331908,332358,336458,343729,353253,363003,384586,387127,387513,390225,391070,397809,398625,404476,411950,426137,427949,435998,683713,836768,874225,881155,934467,955855,972190,986834,3004786,3131592,3449701,6569181,13103664,23957317,25460099,25848899,30822601,34322384,35921712,36385735,37326955,44459532,51174327,59505020,61023831,74859451,84159238,109373551,118218449,133833909,170205476,212766522,228809907,231691952,241908542,253706543,253891410,254957567,260334235,262264756,263559030,266797777,272761870,279346385,283154866,305614922,315986912,316229534,324565060,337454005,344562930,345057935,403055588,413547123,424080297,540573682,545985501,552805228,567714077,571787485,580093078,590925300,604186415,612817599,635688353,645869897,653533044,656458081,676755414,682363064,688617627,695310535,700837637,1677875322,1678014439,1683252955,1804385326,531375,878525,4509158,5673221,12763408,20334304,22615575,22815461,26271308,37259571,99150697,171747553,421343834,21145,31973,92816,126475,127102,138644,171577,205573,258823,269706,312375,323502,326300,383462,384522,410350,410710,419357,420144,517300,519889,526391,563369,648902,666672,671797,677433,682078,682795,683733,691202,691530,695938,704861,770402,873862,874013,874042,874071,874851,876834,877136,877322,877769,878704,879555,880275,880574,881570,882299,882894,915717,1241120,1661655,2582196,3254805,4463198,4493091,4497069,5060870,5436424,5490205,6866000,9237218,9263975,9588449,10393508,12617215,12867453,22355012,23827425,26271632,36685040,38270380,42153793,47267950,59049758,109019149,112578214,131475881,142894722,262890984,264416006,281129651,285223104,413168171,417010627,538321028,610185344,657892334,716108108,1675845293,1842922977,361581,30900,408908,875616,877907,879809,880587,882974,9274776,35752172,36594554,38889915,82623951,347117983,36158,380156,400258,410418,771286,874080,874170,874260,874829,874861,874986,875044,877117,877933,878052,878418,878572,878598,878807,879440,879835,879893,880166,882039,882547,882698,883357,883723,1379992,1539526,2482271,2488870,3277902,4480929,4492895,4509042,5433989,5472053,5545031,5575412,5576858,5646981,5750742,5801095,5801542,5939268,6388015,6444003,6462589,6464311,6526228,7658243,7689785,7913305,8088598,8101072,8178855,8193168,8193316,8285079,8707363,8807870,8910896,8970300,9283092,9475874,9673133,11313667,11418785,12736079,13634014,20377223,21787196,22560945,22986030,23554652,24275391,24905100,26590018,28458797,29035496,29211752,29763167,30536982,30585735,34765135,34902484,35196211,36190710,36311728,38808585,39094234,39388687,44227288,44919095,47616139,49589843,52210519,54291028,60427403,60869480,62449809,62494979,100540285,106835239,108461127,113466343,113583917,114128173,118522514,133003446,141109936,144735147,154136153,216296059,240941024,243280507,268998437,270058482,274645183,278397943,280746379,281298395,311626862,406473162,548164770,632301820,657919499,660797233,684288318,715069504,717761940,875660,878500,878590,881366,882202,882719,1319678,2457663,6125891,7643883,7688917,7688969,9110773,12436042,23713877,24404490,30087775,30347332,30967672,44457309,128102912,222394811,272945665,317086878,542889050,19691,25777,27862,28338,29096,32052,33254,33797,34378,34709,36216,36627,93339,94614,103678,106335,107633,108443,111756,123844,125775,140233,172207,177698,189539,201105,220278,238570,245507,250388,251230,252978,257682,258823,260725,262247,262639,263295,265621,266974,267555,267761,269660,270961,272285,282590,285880,288502,292268,293447,294167,294382,295368)
GROUP BY    rd.researchcontributorid,rd.contributorShortName,CT.relatedCompanyId



IF OBJECT_ID('TEMPDB..#TempCoverageVIDs') IS NOT NULL DROP TABLE #TempCoverageVIDs 
SELECT DISTINCT researchcontributorid,contributorShortName,relatedCompanyId,MaxFilingDate,
CONCAT(researchcontributorid,relatedCompanyId) AS UniqueID,CONCAT(researchcontributorid,' ',relatedCompanyId,' ',MaxFilingDate) AS UniqueIDs INTO #TempCoverageVIDs FROM #CoverageVIDs


---SELECT * FROM #TempCoverageVIDs

IF OBJECT_ID('TEMPDB..#TempCCComb') IS NOT NULL DROP TABLE #TempCCComb 
SELECT DISTINCT researchcontributorid,companyId,CONCAT(researchcontributorid,companyId) AS UniqueID INTO #TempCCComb FROM #CCComb

---SELECT * FROM #TempCCComb

--IF OBJECT_ID('TEMPDB..#Tempevent') IS NOT NULL DROP TABLE #Tempevent
--SELECT DISTINCT ISNULL(e.versionId,e.feedFileId) AS VersionId,e.companyId,e.researchcontributorid,e.effectiveDate,e.eventtypeid,CONCAT(e.researchcontributorid,' ',e.companyId,' ',e.effectiveDate) AS uniqueID 
--INTO #Tempevent FROM Estimates.dbo.Event_tbl e
--INNER JOIN #TempCCComb cc ON cc.companyId = e.companyId AND cc.researchContributorId = e.researchcontributorid
--INNER JOIN #TempCoverageVIDs cv (NOLOCK) ON e.researchcontributorid=cv.researchcontributorid AND cc.companyId=cv.relatedCompanyId AND e.effectiveDate = cv.MaxFilingDate
--WHERE e.eventtypeid IN (1,10)

IF OBJECT_ID('TEMPDB..#Tempfinall1') IS NOT NULL DROP TABLE #Tempfinall1 
SELECT DISTINCT cc.researchContributorId,ISNULL(dbo.researchcontributorname_fn(cc.researchcontributorid),cv.contributorShortName) AS ContributorName,
cc.companyId AS Thomson_companyId,cv.relatedCompanyId AS Ciq_companyId,cv.MaxFilingDate,
CASE WHEN cc.companyId = cv.relatedCompanyId THEN 'YES' ELSE 'NO' END AS Ciq_Coverage
INTO #Tempfinall1 FROM #TempCCComb cc
LEFT JOIN #TempCoverageVIDs cv ON cv.UniqueID = cc.UniqueID

IF OBJECT_ID('TEMPDB..#Tempfinalll2') IS NOT NULL DROP TABLE #Tempfinalll2 
SELECT DISTINCT e.versionId,e.companyId,MAX(e.effectiveDate) AS MaxFilingDate_DC,e.eventTypeId,e.researchContributorId INTO #Tempfinalll2 FROM Estimates.dbo.Event_tbl e
INNER JOIN #TempCoverageVIDs cv ON cv.researchContributorId=e.researchContributorId AND cv.relatedCompanyId=e.companyId AND cv.MaxFilingDate<e.effectiveDate
WHERE e.eventTypeId IN (10) AND e.feedFileId IS NULL
GROUP BY e.versionId,e.companyId,e.eventTypeId,e.researchContributorId

---SELECT * FROM #Tempfinalls2

IF OBJECT_ID('TEMPDB..#Tempfinalll3') IS NOT NULL DROP TABLE #Tempfinalll3
SELECT DISTINCT companyId,eventTypeId,researchContributorId,MAX(MaxFilingDate_DC) AS MaxFilingDate_TOC INTO #Tempfinalll3 FROM #Tempfinalll2
GROUP BY companyId,eventTypeId,researchContributorId

---SELECT * FROM #Tempfinalll3

IF OBJECT_ID('TEMPDB..#Tempfinal') IS NOT NULL DROP TABLE #Tempfinal
SELECT DISTINCT f1.*,f2.eventTypeId,f2.MaxFilingDate_TOC INTO #Tempfinal FROM #Tempfinall1 f1
LEFT JOIN #Tempfinalll3 f2 ON f2.companyId = f1.Ciq_companyId AND f2.researchContributorId = f1.researchContributorId


SELECT DISTINCT * FROM #Tempfinal







